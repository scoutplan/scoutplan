# Kamal deployment configuration for Scoutplan
# See https://kamal-deploy.org for documentation

service: scoutplan

image: scoutplanapp/scoutplan

servers:
  web:
    hosts:
      - 134.209.45.159

  worker:
    hosts:
      - 134.209.45.159
    cmd: bin/jobs

proxy:
  ssl: true
  host: go.scoutplan.org
  app_port: 3000
  healthcheck:
    path: /up
    interval: 5
    timeout: 30

# Docker Hub registry
registry:
  username: scoutplanapp
  password:
    - KAMAL_REGISTRY_PASSWORD

# Build directly on the server using remote Docker
builder:
  remote: ssh://root@134.209.45.159
  arch: amd64
  secrets:
    - RAILS_MASTER_KEY

# Environment variables - secrets are read from .kamal/secrets
env:
  secret:
    - RAILS_MASTER_KEY
    - SECRET_KEY_BASE
    - DATABASE_URL
    - REDIS_URL
    - POSTMARK_API_TOKEN
    - STRIPE_SECRET_KEY
    - STRIPE_PUBLIC_KEY
    - OPENWEATHER_API_KEY
    - SCOUT_KEY
    - DO_STORAGE_KEY_ID
    - DO_STORAGE_SECRET
    - DO_BUCKET
    - DO_STORAGE_ENDPOINT
    - DO_STORAGE_REGION
    - GOOGLE_OAUTH_CLIENT_ID
    - GOOGLE_OAUTH_CLIENT_SECRET
    - GOOGLE_API_KEY
    - TWILIO_SID
    - TWILIO_TOKEN
    - TWILIO_NUMBER
    - SMS_BASIC_USERNAME
    - SMS_BASIC_PASSWORD
    - SMTP_PASSWORD
    - SMTP_USERNAME
    - SMTP_ADDRESS
    - SMTP_PORT
    - SMTP_DOMAIN
    - LOGTAIL_TOKEN
    - BLAZER_DATABASE_URL
    - SENTRY_DSN
    - SCOUTPLAN_ADMINS
    - CONVERTAPI_KEY
    - CONVERTAPI_SECRET
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: "1"
    RAILS_SERVE_STATIC_FILES: "true"
    RAILS_LOG_LEVEL: info
    SCOUTPLAN_HOST: go.scoutplan.org
    SCOUTPLAN_PROTOCOL: https
    EMAIL_DOMAIN: mail.scoutplan.org
    LOGGER_HOST: logs6.papertrailapp.com
    LOGGER_PORT: "46920"
    SKYLIGHT_ENABLED: "true"
    FONT_AWESOME_KIT_ID: 51f1cc9fb4
    ADOBE_FONT_KIT_ID: yrz7cru
    APP_HOST: go.scoutplan.org

# Volumes for persistent storage
volumes:
  - "scoutplan_storage:/rails/storage"

# Asset bridging for zero-downtime deployments
asset_path: /app/public/assets

# SSH user (default is root)
ssh:
  user: root
